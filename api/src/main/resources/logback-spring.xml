<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- 變數定義 -->
    <property name="LOG_PATH" value="${LOG_PATH:-./logs}"/>
    <property name="LOG_FILE" value="${LOG_FILE:-baby-development-backend}"/>
    <property name="LOGSTASH_HOST" value="${LOGSTASH_HOST:-localhost}"/>
    <property name="LOGSTASH_PORT" value="${LOGSTASH_PORT:-5000}"/>
    <property name="APP_NAME" value="${spring.application.name:-baby-development-backend}"/>

    <!-- Logstash 開關：透過環境變數或系統屬性控制 -->
    <property name="LOGSTASH_ENABLED" value="${LOGSTASH_ENABLED:-false}"/>

    <!-- Console Appender - 開發環境使用 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- File Appender - 滾動日誌檔案 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/${LOG_FILE}.log</file>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- Error File Appender - 僅記錄錯誤日誌 -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <file>${LOG_PATH}/${LOG_FILE}-error.log</file>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>${LOG_PATH}/${LOG_FILE}-error-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- Logstash Appender - 只在啟用時才定義 -->
    <if condition='property("LOGSTASH_ENABLED").contains("true")'>
        <then>
            <!-- Logstash Appender - 串接到 ELK -->
            <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
                <destination>${LOGSTASH_HOST}:${LOGSTASH_PORT}</destination>
                <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                    <!-- 應用名稱 -->
                    <customFields>{"app":"${APP_NAME}"}</customFields>
                    <!-- 包含呼叫者資訊 -->
                    <includeCallerData>false</includeCallerData>
                    <!-- 包含 MDC 資料 -->
                    <includeMdc>true</includeMdc>
                    <!-- 包含 context name -->
                    <includeContext>true</includeContext>
                    <!-- 包含 structured arguments -->
                    <includeStructuredArguments>true</includeStructuredArguments>
                </encoder>
                <!-- 連線逾時設定 -->
                <connectionTimeout>5000</connectionTimeout>
                <!-- 重連延遲 -->
                <reconnectionDelay>30 seconds</reconnectionDelay>
                <!-- 写入超时 -->
                <writeTimeout>5000</writeTimeout>
                <!-- 队列大小 -->
                <queueSize>8192</queueSize>
                <!-- 即使連線失敗也不輸出錯誤日誌到 stderr -->
                <quiet>true</quiet>
            </appender>

            <!-- Async Logstash Appender - 非同步處理提升效能 -->
            <appender name="ASYNC_LOGSTASH" class="ch.qos.logback.classic.AsyncAppender">
                <appender-ref ref="LOGSTASH"/>
                <queueSize>512</queueSize>
                <discardingThreshold>0</discardingThreshold>
                <neverBlock>true</neverBlock>
            </appender>
        </then>
    </if>

    <!-- Logger 設定 -->
    <!-- Spring Framework Logger -->
    <logger name="org.springframework" level="INFO"/>

    <!-- Hibernate Logger - 僅記錄重要日誌 -->
    <logger name="org.hibernate" level="INFO"/>

    <!-- Hibernate SQL Logger - 預設關閉（不記錄查詢） -->
    <!-- 如需查看所有 SQL（含查詢），請將 level 設為 DEBUG -->
    <logger name="org.hibernate.SQL" level="INFO"/>

    <!-- Hibernate 參數綁定 - 預設關閉 -->
    <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="INFO"/>

    <!-- Hibernate 事務管理 - 記錄事務相關資訊 -->
    <logger name="org.hibernate.transaction" level="INFO"/>
    <logger name="org.hibernate.engine.transaction" level="INFO"/>

    <!-- Hibernate 統計資訊 - 可選：啟用後可看到實體的異動統計 -->
    <!-- <logger name="org.hibernate.stat" level="DEBUG"/> -->

    <!-- Root Logger -->
    <springProfile name="dev,default">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
            <appender-ref ref="ERROR_FILE"/>
        </root>
    </springProfile>

    <springProfile name="prod">
        <root level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="ERROR_FILE"/>
            <!-- 只有在啟用 Logstash 時才引用（預設不啟用） -->
            <!-- 若要啟用，請設置環境變數: LOGSTASH_ENABLED=true -->
            <if condition='property("LOGSTASH_ENABLED").contains("true")'>
                <then>
                    <appender-ref ref="ASYNC_LOGSTASH"/>
                </then>
            </if>
        </root>
    </springProfile>

    <!-- 如果沒有指定 profile，使用預設配置 -->
    <springProfile name="!dev &amp; !prod">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
            <appender-ref ref="ERROR_FILE"/>
        </root>
    </springProfile>
</configuration>

# Logstash Configuration for Baby Development Backend
# 將此配置文件放在你的 Logstash config 目錄中 (通常在 /etc/logstash/conf.d/ 或 pipeline 目錄)

input {
  # TCP Input for Logback Logstash Encoder
  tcp {
    port => 5000
    codec => json_lines
    type => "baby-development-backend"
  }
}

filter {
  # 解析 JSON 格式的日誌
  if [type] == "baby-development-backend" {

    # 添加時間戳記處理
    date {
      match => ["@timestamp", "ISO8601"]
      target => "@timestamp"
    }

    # 解析 logger 名稱
    if [logger_name] {
      mutate {
        add_field => { "service_name" => "%{[app]}" }
        add_field => { "logger" => "%{[logger_name]}" }
      }
    }

    # 解析日誌等級
    if [level] {
      mutate {
        uppercase => ["level"]
        add_field => { "log_level" => "%{level}" }
      }
    }

    # 解析 thread 資訊
    if [thread_name] {
      mutate {
        add_field => { "thread" => "%{thread_name}" }
      }
    }

    # 處理異��堆疊追蹤
    if [stack_trace] {
      mutate {
        add_field => { "exception" => "%{stack_trace}" }
      }
    }

    # 添加環境標籤
    mutate {
      add_field => { "environment" => "production" }
    }
  }
}

output {
  # 輸出到 Elasticsearch
  if [type] == "baby-development-backend" {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "baby-development-backend-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }

    # 可選：同時輸出到標準輸出用於除錯
    # stdout {
    #   codec => rubydebug
    # }
  }
}

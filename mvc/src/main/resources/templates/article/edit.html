<!DOCTYPE html>
<html lang="zh-Hant"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{dashboardLayout}">
<head>
    <meta charset="UTF-8">
    <title>ç·¨è¼¯ Article</title>
    <!-- CKEditor CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
    <style>
        .ck-editor__editable {
            min-height: 300px;
        }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="max-w-5xl mx-auto py-8">
        <div class="flex items-center mb-6">
            <a th:href="@{/articles}" class="text-primary hover:text-primary/80 mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <h1 class="text-3xl font-bold text-primary">ç·¨è¼¯ Article</h1>
        </div>

        <div class="card-bg p-8 rounded-lg shadow-md">
            <form id="articleForm">
                <input type="hidden" id="articleId" th:value="${article.id}">

                <!-- åˆ†é¡é¸æ“‡ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">
                        åˆ†é¡ <span class="text-red-500">*</span>
                    </label>
                    <select id="categoryId" required
                            class="w-full px-4 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary">
                        <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                        <option th:each="category : ${categories}"
                                th:value="${category.value}"
                                th:text="${category.label}"
                                th:selected="${article.category != null and article.category.id.toString() == category.value}">
                        </option>
                    </select>
                </div>

                <hr class="my-6 border-gray-300 dark:border-gray-600">

                <!-- å¤šèªè¨€ç¿»è­¯å€ -->
                <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">å¤šèªè¨€å…§å®¹</h2>

                <div id="translationsContainer" class="space-y-6">
                    <!-- è‹±æ–‡ -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">ğŸ‡¬ğŸ‡§</span> è‹±æ–‡ (English)
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">æ¨™é¡Œ</label>
                                <input type="text" data-lang="ENGLISH" data-field="title"
                                       class="translation-input w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                       placeholder="Enter title in English">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">å…§å®¹</label>
                                <div id="editor-ENGLISH" data-lang="ENGLISH" data-field="content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¹é«”ä¸­æ–‡ -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">ğŸ‡¹ğŸ‡¼</span> ç¹é«”ä¸­æ–‡ (Traditional Chinese)
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">æ¨™é¡Œ</label>
                                <input type="text" data-lang="TRADITIONAL_CHINESE" data-field="title"
                                       class="translation-input w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                       placeholder="è¼¸å…¥ç¹é«”ä¸­æ–‡æ¨™é¡Œ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">å…§å®¹</label>
                                <div id="editor-TRADITIONAL_CHINESE" data-lang="TRADITIONAL_CHINESE" data-field="content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ç°¡é«”ä¸­æ–‡ -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">ğŸ‡¨ğŸ‡³</span> ç®€ä½“ä¸­æ–‡ (Simplified Chinese)
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">æ ‡é¢˜</label>
                                <input type="text" data-lang="SIMPLIFIED_CHINESE" data-field="title"
                                       class="translation-input w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                       placeholder="è¾“å…¥ç®€ä½“ä¸­æ–‡æ ‡é¢˜">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">å†…å®¹</label>
                                <div id="editor-SIMPLIFIED_CHINESE" data-lang="SIMPLIFIED_CHINESE" data-field="content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥æ–‡ -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">ğŸ‡¯ğŸ‡µ</span> æ—¥æœ¬èª (Japanese)
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">ã‚¿ã‚¤ãƒˆãƒ«</label>
                                <input type="text" data-lang="JAPANESE" data-field="title"
                                       class="translation-input w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                       placeholder="æ—¥æœ¬èªã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">å†…å®¹</label>
                                <div id="editor-JAPANESE" data-lang="JAPANESE" data-field="content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- éŸ“æ–‡ -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">ğŸ‡°ğŸ‡·</span> í•œêµ­ì–´ (Korean)
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">ì œëª©</label>
                                <input type="text" data-lang="KOREAN" data-field="title"
                                       class="translation-input w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                       placeholder="í•œêµ­ì–´ ì œëª© ì…ë ¥">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">ë‚´ìš©</label>
                                <div id="editor-KOREAN" data-lang="KOREAN" data-field="content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- è¶Šå—æ–‡ -->
                    <div class="border border-gray-300 dark:border-gray-600 rounded-lg p-4">
                        <h3 class="font-semibold mb-3 text-gray-900 dark:text-gray-100 flex items-center">
                            <span class="mr-2">ğŸ‡»ğŸ‡³</span> Tiáº¿ng Viá»‡t (Vietnamese)
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">TiÃªu Ä‘á»</label>
                                <input type="text" data-lang="VIETNAMESE" data-field="title"
                                       class="translation-input w-full px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                       placeholder="Nháº­p tiÃªu Ä‘á» tiáº¿ng Viá»‡t">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Ná»™i dung</label>
                                <div id="editor-VIETNAMESE" data-lang="VIETNAMESE" data-field="content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex gap-4">
                    <button type="submit"
                            class="bg-primary text-white px-6 py-2 rounded hover:bg-opacity-90 transition-colors">
                        æ›´æ–°
                    </button>
                    <a th:href="@{/articles}"
                       class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600 transition-colors inline-block">
                        å–æ¶ˆ
                    </a>
                </div>
            </form>
        </div>

        <!-- Loading è¦†è“‹å±¤ -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl">
                <div class="flex items-center space-x-3">
                    <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-lg text-gray-900 dark:text-gray-100">æ›´æ–°ä¸­...</span>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const article = /*[[${article}]]*/ {};
        const form = document.getElementById('articleForm');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // å„²å­˜æ‰€æœ‰ CKEditor å¯¦ä¾‹
        const editors = {};
        const languages = ['ENGLISH', 'TRADITIONAL_CHINESE', 'SIMPLIFIED_CHINESE', 'JAPANESE', 'KOREAN', 'VIETNAMESE'];

        // åˆå§‹åŒ–æ‰€æœ‰ CKEditor ä¸¦è¼‰å…¥ç¾æœ‰è³‡æ–™
        window.addEventListener('DOMContentLoaded', async () => {
            // åˆå§‹åŒ– CKEditor
            for (const lang of languages) {
                try {
                    const editor = await ClassicEditor.create(document.querySelector(`#editor-${lang}`), {
                        toolbar: {
                            items: [
                                'heading', '|',
                                'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|',
                                'blockQuote', 'insertTable', '|',
                                'undo', 'redo'
                            ]
                        },
                        language: 'zh',
                        table: {
                            contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                        }
                    });
                    editors[lang] = editor;
                } catch (error) {
                    console.error(`Error initializing CKEditor for ${lang}:`, error);
                }
            }

            // è¼‰å…¥ç¾æœ‰è³‡æ–™
            if (article && article.translations) {
                article.translations.forEach(translation => {
                    const langCode = translation.languageCode.name || translation.languageCode;

                    // å¡«å…¥æ¨™é¡Œ
                    const titleInput = document.querySelector(`input[data-lang="${langCode}"][data-field="title"]`);
                    if (titleInput && translation.title) {
                        titleInput.value = translation.title;
                    }

                    // å¡«å…¥å…§å®¹åˆ° CKEditor
                    const editor = editors[langCode];
                    if (editor && translation.content) {
                        editor.setData(translation.content);
                    }
                });
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const articleId = document.getElementById('articleId').value;
            const categoryId = document.getElementById('categoryId').value;

            if (!categoryId) {
                alert('è«‹é¸æ“‡åˆ†é¡');
                return;
            }

            // æ”¶é›†æ‰€æœ‰ç¿»è­¯è³‡æ–™
            const translations = [];
            const translationMap = {};

            // æ”¶é›†æ¨™é¡Œ
            const titleInputs = document.querySelectorAll('input[data-field="title"]');
            titleInputs.forEach(input => {
                const lang = input.getAttribute('data-lang');
                const value = input.value.trim();

                if (value) {
                    if (!translationMap[lang]) {
                        translationMap[lang] = { languageCode: lang };
                    }
                    translationMap[lang].title = value;
                }
            });

            // æ”¶é›†å…§å®¹ (å¾ CKEditor)
            languages.forEach(lang => {
                const editor = editors[lang];
                if (editor) {
                    const content = editor.getData().trim();
                    if (content) {
                        if (!translationMap[lang]) {
                            translationMap[lang] = { languageCode: lang };
                        }
                        translationMap[lang].content = content;
                    }
                }
            });

            // åªåŠ å…¥æœ‰å…§å®¹çš„ç¿»è­¯
            Object.values(translationMap).forEach(translation => {
                if (translation.title || translation.content) {
                    translations.push(translation);
                }
            });

            if (translations.length === 0) {
                alert('è«‹è‡³å°‘å¡«å¯«ä¸€ç¨®èªè¨€çš„å…§å®¹');
                return;
            }

            const requestData = {
                id: articleId,
                categoryId: categoryId,
                translations: translations
            };

            try {
                loadingOverlay.classList.remove('hidden');

                const csrfToken = /*[[${_csrf.token}]]*/ '';
                const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

                const response = await fetch(`/articles/${articleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    window.location.href = '/articles?success=Article æ›´æ–°æˆåŠŸ';
                } else {
                    const error = await response.text();
                    alert('æ›´æ–°å¤±æ•—: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });
    </script>
</section>
</body>
</html>

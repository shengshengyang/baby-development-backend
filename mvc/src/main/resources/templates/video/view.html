<!DOCTYPE html>
<html lang="zh-Hant"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{dashboardLayout}">
<head>
    <meta charset="UTF-8">
    <title>Video 詳情</title>
</head>
<body>
<section layout:fragment="content">
    <div class="max-w-4xl mx-auto py-8">
        <h1 class="text-3xl font-bold mb-6 text-primary"
            th:text="${editMode ? '編輯 Video' : 'Video 詳情'}">Video 詳情</h1>

        <!-- 返回按鈕和操作按鈕 -->
        <div class="mb-6 flex space-x-3">
            <a th:href="@{/video}"
               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                返回列表
            </a>

            <!-- 編輯/查看切換按鈕 -->
            <a th:if="${!editMode}"
               th:href="@{'/video/view/' + ${video.id} + '?edit=true'}"
               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md shadow-sm hover:bg-blue-700">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                編輯
            </a>

            <a th:if="${editMode}"
               th:href="@{'/video/view/' + ${video.id}}"
               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                取消編輯
            </a>
        </div>

        <!-- 成功/錯誤訊息 -->
        <div th:if="${success}" class="mb-6 p-4 rounded-lg success-bg border">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-green-600 dark:text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span class="success-text" th:text="${success}"></span>
            </div>
        </div>

        <div th:if="${error}" class="mb-6 p-4 rounded-lg error-bg border">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-red-600 dark:text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span class="error-text" th:text="${error}"></span>
            </div>
        </div>

        <!-- 編輯模式：表單 -->
        <div th:if="${editMode}" class="card-bg p-6 rounded-lg shadow-md">
            <form th:action="@{'/video/view/' + ${video.id}}" method="post" th:object="${videoForm}">

                <!-- 基本資訊 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Video URL -->
                    <div class="md:col-span-2">
                        <label for="videoUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Video URL <span class="text-red-500">*</span>
                        </label>
                        <input type="url"
                               id="videoUrl"
                               th:field="*{videoUrl}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                               placeholder="https://example.com/video.mp4"
                               required>
                    </div>

                    <!-- Duration -->
                    <div>
                        <label for="durationSeconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            時長（秒）
                        </label>
                        <input type="number"
                               id="durationSeconds"
                               th:field="*{durationSeconds}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                               placeholder="例如：180"
                               min="1">
                    </div>

                    <!-- Thumbnail URL -->
                    <div>
                        <label for="thumbnailUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            縮圖 URL
                        </label>
                        <input type="url"
                               id="thumbnailUrl"
                               th:field="*{thumbnailUrl}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                               placeholder="https://example.com/thumbnail.jpg">
                    </div>
                </div>

                <!-- 多語言描述 -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">描述（多語言）</h3>
                    <div class="space-y-4">
                        <!-- 繁體中文 -->
                        <div>
                            <label for="descriptionTw" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                繁體中文
                            </label>
                            <textarea id="descriptionTw"
                                      th:field="*{descriptionTw}"
                                      rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                      placeholder="輸入繁體中文描述..."></textarea>
                        </div>

                        <!-- 英文 -->
                        <div>
                            <label for="descriptionEn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                English
                            </label>
                            <textarea id="descriptionEn"
                                      th:field="*{descriptionEn}"
                                      rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                      placeholder="Enter English description..."></textarea>
                        </div>

                        <!-- 簡體中文 -->
                        <div>
                            <label for="descriptionCn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                简体中文
                            </label>
                            <textarea id="descriptionCn"
                                      th:field="*{descriptionCn}"
                                      rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                      placeholder="输入简体中文描述..."></textarea>
                        </div>

                        <!-- 日文 -->
                        <div>
                            <label for="descriptionJa" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                日本語
                            </label>
                            <textarea id="descriptionJa"
                                      th:field="*{descriptionJa}"
                                      rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                      placeholder="日本語の説明を入力してください..."></textarea>
                        </div>

                        <!-- 韓文 -->
                        <div>
                            <label for="descriptionKo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                한국어
                            </label>
                            <textarea id="descriptionKo"
                                      th:field="*{descriptionKo}"
                                      rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                      placeholder="한국어 설명을 입력하세요..."></textarea>
                        </div>

                        <!-- 越南文 -->
                        <div>
                            <label for="descriptionVi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Tiếng Việt
                            </label>
                            <textarea id="descriptionVi"
                                      th:field="*{descriptionVi}"
                                      rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                                      placeholder="Nhập mô tả tiếng Việt..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- 提交按鈕 -->
                <div class="flex justify-end space-x-3">
                    <a th:href="@{'/video/view/' + ${video.id}}"
                       class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                        取消
                    </a>
                    <button type="submit"
                            class="px-4 py-2 bg-primary text-white rounded-md shadow-sm hover:bg-opacity-90 focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                        更新
                    </button>
                </div>
            </form>
        </div>

        <!-- 查看模式：顯示內容 -->
        <div th:if="${!editMode}" class="card-bg p-6 rounded-lg shadow-md">
            <!-- Video 播放器 -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100">Video 播放</h2>
                <div class="relative bg-black rounded-lg overflow-hidden" style="aspect-ratio: 16/9;">
                    <div th:if="${video.videoUrl != null}"
                         id="video-container"
                         th:data-video-url="${video.videoUrl}"
                         th:data-thumbnail-url="${video.thumbnailUrl}"
                         class="w-full h-full">
                        <!-- 視頻內容將由 JavaScript 動態載入 -->
                    </div>
                    <div th:if="${video.videoUrl == null}"
                         class="w-full h-full flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                      d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <p>無可用的視頻</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 基本資訊 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Video URL -->
                <div class="md:col-span-2">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">Video URL</h3>
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                        <span th:if="${video.videoUrl != null}"
                              class="text-sm text-gray-700 dark:text-gray-300 break-all"
                              th:text="${video.videoUrl}">
                        </span>
                        <span th:if="${video.videoUrl == null}"
                              class="text-sm text-gray-500 dark:text-gray-400">未設定</span>
                    </div>
                </div>

                <!-- 時長 -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">時長</h3>
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                        <span th:if="${video.durationSeconds != null}"
                              th:text="${T(java.time.Duration).ofSeconds(video.durationSeconds).toString().substring(2).replaceAll('(\\d[HMS])(?!$)', '$1 ').toLowerCase()}"
                              class="text-sm text-gray-700 dark:text-gray-300">
                        </span>
                        <span th:if="${video.durationSeconds == null}"
                              class="text-sm text-gray-500 dark:text-gray-400">未設定</span>
                    </div>
                </div>

                <!-- 縮圖 URL -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">縮圖 URL</h3>
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                        <span th:if="${video.thumbnailUrl != null}"
                              class="text-sm text-gray-700 dark:text-gray-300 break-all"
                              th:text="${video.thumbnailUrl}">
                        </span>
                        <span th:if="${video.thumbnailUrl == null}"
                              class="text-sm text-gray-500 dark:text-gray-400">未設定</span>
                    </div>
                </div>
            </div>

            <!-- 關聯資訊 -->
            <div class="mb-8">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">關聯資訊</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- 里程碑 -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded border">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">關聯里程碑</h4>
                        <span th:if="${video.milestone != null}"
                              th:text="${video.milestone.description?.getLangByLocaleName()}"
                              class="text-sm text-green-600 dark:text-green-400">
                        </span>
                        <span th:if="${video.milestone == null}"
                              class="text-sm text-gray-500 dark:text-gray-400">無關聯</span>
                    </div>

                    <!-- FlashCard -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded border">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">關聯 FlashCard</h4>
                        <span th:if="${video.flashcard != null}"
                              th:text="${video.flashcard.subject?.getLangByLocaleName()}"
                              class="text-sm text-purple-600 dark:text-purple-400">
                        </span>
                        <span th:if="${video.flashcard == null}"
                              class="text-sm text-gray-500 dark:text-gray-400">無關聯</span>
                    </div>

                    <!-- 文章 -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded border">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">關聯文章</h4>
                        <span th:if="${video.article != null}"
                              th:text="${video.article.title?.getLangByLocaleName()}"
                              class="text-sm text-yellow-600 dark:text-yellow-400">
                        </span>
                        <span th:if="${video.article == null}"
                              class="text-sm text-gray-500 dark:text-gray-400">無關聯</span>
                    </div>
                </div>
            </div>

            <!-- 多語言描述 -->
            <div th:if="${video.description != null}">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">描述</h3>
                <div class="space-y-4">
                    <!-- 繁體中文 -->
                    <div th:if="${video.description.tw != null and !#strings.isEmpty(video.description.tw)}">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">繁體中文</h4>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                            <p class="text-sm text-gray-700 dark:text-gray-300" th:text="${video.description.tw}"></p>
                        </div>
                    </div>

                    <!-- 英文 -->
                    <div th:if="${video.description.en != null and !#strings.isEmpty(video.description.en)}">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">English</h4>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                            <p class="text-sm text-gray-700 dark:text-gray-300" th:text="${video.description.en}"></p>
                        </div>
                    </div>

                    <!-- 簡體中文 -->
                    <div th:if="${video.description.cn != null and !#strings.isEmpty(video.description.cn)}">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">简体中文</h4>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                            <p class="text-sm text-gray-700 dark:text-gray-300" th:text="${video.description.cn}"></p>
                        </div>
                    </div>

                    <!-- 日文 -->
                    <div th:if="${video.description.ja != null and !#strings.isEmpty(video.description.ja)}">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">日本語</h4>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                            <p class="text-sm text-gray-700 dark:text-gray-300" th:text="${video.description.ja}"></p>
                        </div>
                    </div>

                    <!-- 韓文 -->
                    <div th:if="${video.description.ko != null and !#strings.isEmpty(video.description.ko)}">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">한국어</h4>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                            <p class="text-sm text-gray-700 dark:text-gray-300" th:text="${video.description.ko}"></p>
                        </div>
                    </div>

                    <!-- 越南文 -->
                    <div th:if="${video.description.vi != null and !#strings.isEmpty(video.description.vi)}">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">Tiếng Việt</h4>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border">
                            <p class="text-sm text-gray-700 dark:text-gray-300" th:text="${video.description.vi}"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 無描述時顯示 -->
            <div th:if="${video.description == null}" class="text-center py-8">
                <div class="text-gray-500 dark:text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>暫無描述內容</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 處理視頻播放 (只在查看模式時執行) -->
    <script th:if="${!editMode}">
        document.addEventListener('DOMContentLoaded', function() {
            const videoContainer = document.getElementById('video-container');
            if (!videoContainer) return;

            const videoUrl = videoContainer.dataset.videoUrl;
            const thumbnailUrl = videoContainer.dataset.thumbnailUrl;

            if (!videoUrl) return;

            // 檢測 YouTube URL 並轉換為嵌入式格式
            function getYouTubeEmbedUrl(url) {
                const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
                const match = url.match(regex);
                if (match) {
                    return `https://www.youtube.com/embed/${match[1]}`;
                }
                return null;
            }

            // 檢測 Vimeo URL 並轉換為嵌入式格式
            function getVimeoEmbedUrl(url) {
                const regex = /vimeo\.com\/(\d+)/;
                const match = url.match(regex);
                if (match) {
                    return `https://player.vimeo.com/video/${match[1]}`;
                }
                return null;
            }

            // 檢測是否為 YouTube 連結
            const youtubeEmbedUrl = getYouTubeEmbedUrl(videoUrl);
            if (youtubeEmbedUrl) {
                videoContainer.innerHTML = `
                    <iframe
                        src="${youtubeEmbedUrl}"
                        title="YouTube video player"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen
                        class="w-full h-full">
                    </iframe>
                `;
                return;
            }

            // 檢測是否為 Vimeo 連結
            const vimeoEmbedUrl = getVimeoEmbedUrl(videoUrl);
            if (vimeoEmbedUrl) {
                videoContainer.innerHTML = `
                    <iframe
                        src="${vimeoEmbedUrl}"
                        title="Vimeo video player"
                        frameborder="0"
                        allow="autoplay; fullscreen; picture-in-picture"
                        allowfullscreen
                        class="w-full h-full">
                    </iframe>
                `;
                return;
            }

            // 預設使用 HTML5 video 標籤
            const posterAttribute = thumbnailUrl ? `poster="${thumbnailUrl}"` : '';
            videoContainer.innerHTML = `
                <video controls class="w-full h-full" ${posterAttribute}>
                    <source src="${videoUrl}" type="video/mp4">
                    <source src="${videoUrl}" type="video/webm">
                    <source src="${videoUrl}" type="video/ogg">
                    您的瀏覽器不支援 video 標籤。
                    <p>請<a href="${videoUrl}" target="_blank" class="text-blue-400 underline">點擊此處</a>直接觀看視頻</p>
                </video>
            `;
        });
    </script>
</section>
</body>
</html>

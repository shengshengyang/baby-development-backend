<!DOCTYPE html>
<html lang="zh-Hant"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{dashboardLayout}">
<head>
    <meta charset="UTF-8">
    <title th:text="${flashcard.id != null ? '編輯 Flashcard' : '新增 Flashcard'}">Flashcard 表單</title>
</head>
<body>
<section layout:fragment="content">
    <div class="max-w-4xl mx-auto py-8">
        <!-- 頁面標題 -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-primary mb-2"
                th:text="${flashcard.id != null ? '編輯 Flashcard' : '新增 Flashcard'}"></h1>
            <nav class="text-sm text-gray-600">
                <a th:href="@{/flashcard}" class="hover:text-primary">Flashcard 管理</a>
                <span class="mx-2">/</span>
                <span th:text="${flashcard.id != null ? '編輯' : '新增'}"></span>
            </nav>
        </div>

        <!-- 表單 -->
        <div class="card-bg rounded-lg shadow-md overflow-hidden">
            <form th:action="${flashcard.id != null ? '/flashcard/edit' : '/flashcard/add'}"
                  method="post"
                  th:object="${flashcard}"
                  class="p-6 space-y-6">

                <!-- 隱藏的ID欄位（編輯模式） -->
                <input th:if="${flashcard.id != null}" type="hidden" name="id" th:value="${flashcard.id}" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Category 選擇 -->
                    <div class="space-y-2">
                        <label for="categoryId" class="block text-sm font-medium label-text">
                            分類 <span class="text-red-500">*</span>
                        </label>
                        <select id="categoryId" name="categoryId" required
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                            <option value="">請選擇分類</option>
                            <option th:each="category : ${categories}"
                                    th:value="${category.id}"
                                    th:text="${category.name?.tw != null ? category.name.tw : (category.name?.en != null ? category.name.en : '未命名分類')}"
                                    th:selected="${flashcard.category != null and category.id == flashcard.category.id}">
                            </option>
                        </select>
                    </div>

                    <!-- Milestone 選擇 -->
                    <div class="space-y-2">
                        <label for="milestoneId" class="block text-sm font-medium label-text">
                            里程碑 <span class="text-red-500">*</span>
                        </label>
                        <select id="milestoneId" name="milestoneId" required
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                            <option value="">請選擇里程碑</option>
                            <option th:each="milestone : ${milestones}"
                                    th:value="${milestone.id}"
                                    th:text="${milestone.description?.tw != null ? milestone.description.tw : (milestone.description?.en != null ? milestone.description.en : '未命名里程碑')}"
                                    th:selected="${flashcard.milestone != null and milestone.id == flashcard.milestone.id}">
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Translation 區段 -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">翻譯內容</h3>

                    <!-- Subject (正面文字) - 使用 LangFieldObject -->
                    <div class="space-y-2 mb-6">
                        <label class="block text-sm font-medium label-text">
                            主題/正面文字 <span class="text-red-500">*</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="subjectTw" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">繁體中文</label>
                                <input type="text" id="subjectTw" name="subject.tw" required
                                       th:value="${flashcard.subject?.tw}"
                                       placeholder="請輸入繁體中文主題"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" />
                            </div>
                            <div>
                                <label for="subjectEn" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">英文</label>
                                <input type="text" id="subjectEn" name="subject.en"
                                       th:value="${flashcard.subject?.en}"
                                       placeholder="請輸入英文主題"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" />
                            </div>
                        </div>
                    </div>

                    <!-- 圖片URL - 移到 Flashcard 層級 -->
                    <div class="space-y-2 mb-6">
                        <label for="imageUrl" class="block text-sm font-medium label-text">
                            圖片URL
                        </label>
                        <input type="url" id="imageUrl" name="imageUrl"
                               th:value="${flashcard.imageUrl}"
                               placeholder="https://example.com/image.jpg"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" />

                        <!-- 圖片預覽 -->
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="previewImg" src="" alt="圖片預覽" class="max-w-xs max-h-32 object-cover rounded border">
                        </div>
                    </div>

                    <!-- Description (背面文字) - 保持多語言模式 -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium label-text">
                            描述/背面文字 <span class="text-red-500">*</span>
                        </label>

                        <!-- 語言選擇器 -->
                        <div class="mb-4">
                            <select id="languageSelector"
                                    class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
                                <option value="TRADITIONAL_CHINESE">繁體中文</option>
                                <option value="SIMPLIFIED_CHINESE">簡體中文</option>
                                <option value="ENGLISH">英文</option>
                                <option value="JAPANESE">日文</option>
                                <option value="KOREAN">韓文</option>
                            </select>
                        </div>

                        <!-- 動態翻譯區域 -->
                        <div id="translationContainer">
                            <!-- 如果是編輯模式且有現有翻譯，顯示所有翻譯 -->
                            <div th:if="${flashcard.id != null and !#lists.isEmpty(flashcard.translations)}">
                                <div th:each="translation, iterStat : ${flashcard.translations}"
                                     class="translation-item"
                                     th:data-lang="${translation.languageCode.name()}"
                                     th:style="${iterStat.index == 0 ? 'display: block;' : 'display: none;'}">
                                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1"
                                           th:text="${translation.languageCode.displayName} + '描述'"></label>
                                    <textarea th:name="'translations[' + ${iterStat.index} + '].description'"
                                              rows="4"
                                              th:required="${iterStat.index == 0}"
                                              th:text="${translation.description}"
                                              th:placeholder="'請輸入' + ${translation.languageCode.displayName} + '描述'"
                                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></textarea>
                                    <input type="hidden"
                                           th:name="'translations[' + ${iterStat.index} + '].languageCode'"
                                           th:value="${translation.languageCode.name()}">
                                    <input type="hidden"
                                           th:name="'translations[' + ${iterStat.index} + '].id'"
                                           th:value="${translation.id}">
                                </div>
                            </div>

                            <!-- 如果是新增模式，只顯示預設的繁體中文翻譯 -->
                            <div th:if="${flashcard.id == null or #lists.isEmpty(flashcard.translations)}">
                                <div class="translation-item" data-lang="TRADITIONAL_CHINESE">
                                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">繁體中文描述</label>
                                    <textarea name="translations[0].description" rows="4" required
                                              placeholder="請輸入繁體中文描述"
                                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></textarea>
                                    <input type="hidden" name="translations[0].languageCode" value="TRADITIONAL_CHINESE">
                                </div>
                            </div>
                        </div>

                        <!-- 新增翻譯按鈕 -->
                        <button type="button" id="addTranslationBtn"
                                class="mt-2 px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400 rounded hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors text-sm">
                            + 新增其他語言翻譯
                        </button>
                    </div>
                </div>

                <!-- 表單按鈕 -->
                <div class="flex items-center justify-between pt-6 border-t border-gray-200 dark:border-gray-700">
                    <a th:href="@{/flashcard}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        返回列表
                    </a>

                    <div class="flex space-x-3">
                        <button type="button" id="previewBtn"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            預覽
                        </button>

                        <button type="submit"
                                class="inline-flex items-center px-6 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span th:text="${flashcard.id != null ? '更新' : '新增'}"></span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 預覽Modal -->
    <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Flashcard 預覽</h3>
                    <button id="closeModal" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- 預覽卡片 -->
                <div class="space-y-4">
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">正面</h4>
                        <p id="previewFront" class="text-gray-900 dark:text-gray-100"></p>
                        <img id="previewImageModal" src="" alt="" class="mt-2 max-w-full h-32 object-cover rounded" style="display: none;">
                    </div>
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-2">背面</h4>
                        <p id="previewBack" class="text-gray-900 dark:text-gray-100"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 圖片預覽功能
        document.getElementById('imageUrl').addEventListener('input', function() {
            const url = this.value;
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('previewImg');

            if (url) {
                img.src = url;
                img.onload = function() {
                    preview.style.display = 'block';
                };
                img.onerror = function() {
                    preview.style.display = 'none';
                };
            } else {
                preview.style.display = 'none';
            }
        });

        // 預覽Modal功能
        document.getElementById('previewBtn').addEventListener('click', function() {
            const frontText = document.getElementById('subjectTw').value || document.getElementById('subjectEn').value;
            const backText = document.querySelector('.translation-item[style*="block"] textarea')?.value ||
                           document.querySelector('.translation-item textarea').value;
            const imageUrl = document.getElementById('imageUrl').value;

            document.getElementById('previewFront').textContent = frontText || '（無內容）';
            document.getElementById('previewBack').textContent = backText || '（無內容）';

            const modalImage = document.getElementById('previewImageModal');
            if (imageUrl) {
                modalImage.src = imageUrl;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }

            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewModal').classList.add('flex');
        });

        // 關閉Modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewModal').classList.remove('flex');
        });

        // 點擊背景關閉Modal
        document.getElementById('previewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
                this.classList.remove('flex');
            }
        });

        // 頁面載入時檢查圖片URL
        document.addEventListener('DOMContentLoaded', function() {
            const imageUrl = document.getElementById('imageUrl').value;
            if (imageUrl) {
                document.getElementById('imageUrl').dispatchEvent(new Event('input'));
            }
        });

        // 語言切換功能
        document.getElementById('languageSelector').addEventListener('change', function() {
            const selectedLang = this.value;
            const translationItems = document.querySelectorAll('.translation-item');

            translationItems.forEach(item => {
                item.style.display = 'none';
                if (item.getAttribute('data-lang') === selectedLang) {
                    item.style.display = 'block';
                }
            });
        });

        // 新增翻譯功能
        document.getElementById('addTranslationBtn').addEventListener('click', function() {
            const translationContainer = document.getElementById('translationContainer');
            const translationItems = translationContainer.querySelectorAll('.translation-item');

            // 取得目前所有語言代碼
            const existingLangs = Array.from(translationItems).map(item => item.getAttribute('data-lang'));

            // 定義語言順序 - 使用 Language 枚舉名稱
            const langOrder = ['TRADITIONAL_CHINESE', 'SIMPLIFIED_CHINESE', 'ENGLISH', 'JAPANESE', 'KOREAN'];
            const langDisplayNames = {
                'TRADITIONAL_CHINESE': '繁體中文',
                'SIMPLIFIED_CHINESE': '簡體中文',
                'ENGLISH': '英文',
                'JAPANESE': '日文',
                'KOREAN': '韓文'
            };

            let nextLang = null;

            // 找到下一個可用的語言
            for (let i = 0; i < langOrder.length; i++) {
                if (!existingLangs.includes(langOrder[i])) {
                    nextLang = langOrder[i];
                    break;
                }
            }

            if (nextLang) {
                const nextIndex = translationItems.length;

                // 創建新的翻譯區塊
                const newItem = document.createElement('div');
                newItem.className = 'translation-item';
                newItem.setAttribute('data-lang', nextLang);
                newItem.style.display = 'none';

                newItem.innerHTML = `
                    <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">${langDisplayNames[nextLang]}描述</label>
                    <textarea name="translations[${nextIndex}].description" rows="4"
                              placeholder="請輸入${langDisplayNames[nextLang]}描述"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent resize-none bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"></textarea>
                    <input type="hidden" name="translations[${nextIndex}].languageCode" value="${nextLang}">
                `;

                translationContainer.appendChild(newItem);

                // 更新語言選擇器以顯示新增的語言
                const languageSelector = document.getElementById('languageSelector');
                languageSelector.value = nextLang;
                languageSelector.dispatchEvent(new Event('change'));
            } else {
                alert('已達到最大語言數量，無法新增更多翻譯。');
            }
        });
    </script>
</section>
</body>
</html>
